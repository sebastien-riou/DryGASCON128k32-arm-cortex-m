#include <stdint.h>
#include <string.h>
#include <mbed.h>
#include <unity.h>

#include "supercop_api.h"

#include "drygascon128k32.h"
#include "drygascon128k32_validation.h"

void basic_validation(){
    TEST_ASSERT_EQUAL(0, drygascon128k32_validate_all(crypto_aead_encrypt,crypto_aead_decrypt,crypto_hash));
}

void test_hash_overlapped_io(){
    uint8_t expected[] = {0x91,0xFD,0xCC,0xC6,0x67,0x45,0x46,0x77,0x09,0xDB,0x81,0x6D,0x54,0x32,0x2E,0x37,0xE4,0x7B,0x64,0xBB,0x06,0x94,0x6B,0x1D,0xBC,0x4D,0xAE,0x8F,0xE9,0x80,0x6F,0xB2};
    uint8_t buf[32] = {0};
    crypto_hash(buf,buf,32);
    TEST_ASSERT_EQUAL_MEMORY(expected,buf,sizeof(expected));
}

void test_aead_overlapped_io(){
    uint8_t expected[] = {0x39,0x79,0x2B,0xEE,0xE9,0x41,0x0C,0x57,0x12,0x90,0x20,0x3B,0xC4,0x64,0xDC,0xA5,0xD8,0x0D,0xF1,0xB1,0xA0,0x3A,0x63,0xD0,0x8E,0x55,0xEC,0x0C,0xC5,0xAE,0x24,0x43};
    uint8_t key[] = {0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F};
    uint8_t buf[32] = {0};
    unsigned long long clen;
    crypto_aead_encrypt(buf,&clen,buf,16,buf,16,0,buf, key);
    TEST_ASSERT_EQUAL(sizeof(expected),clen);
    TEST_ASSERT_EQUAL_MEMORY(expected,buf,sizeof(expected));
}

int main(){
    wait_us(5000);//DOC SAYS to wait 2s but some users reported they need 5s
    UNITY_BEGIN();    // IMPORTANT LINE!
    RUN_TEST(basic_validation);
    RUN_TEST(test_hash_overlapped_io);
    #ifdef AEAD_DETECT_OVERLAP
    RUN_TEST(test_aead_overlapped_io);
    #endif
    UNITY_END(); // stop unit testing
}